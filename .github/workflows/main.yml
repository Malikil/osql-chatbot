name: Deploy to Google Cloud Platform

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GCP
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            cd ${{ secrets.GCP_BOT_PATH }} || { echo "Bot directory not found"; exit 1; }
            export PATH="${{ secrets.GCP_NPM_PATH }}:$PATH"
            git fetch origin
            git reset --hard origin/master
            npm ci || { echo "Failed to install dependencies"; exit 1; }
            npm run build || { echo "Build command failed"; exit 1; }
            npm prune --omit=dev
            sudo systemctl restart mpsq-bot
            echo "Deployment completed successfully"
